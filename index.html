<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>aaMMIXtractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    :root { --primary:#0069d9; --success:#28a745; --danger:#e74c3c; --gray:#6c757d; --border:#dee2e6; --dark:#343a40; }
    body{
      margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#f5f7fa 0%,#e4edf5 100%);color:#333;
      display:flex;flex-direction:column;height:100vh;overflow:hidden;
    }
    header{
      background:rgba(255,255,255,.95);backdrop-filter:blur(10px);
      padding:18px 24px;border-bottom:1px solid var(--border);
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      display:flex;flex-wrap:wrap;align-items:center;gap:18px;position:relative;z-index:10;
    }
    .title-container{display:flex;align-items:center;gap:12px;flex:1;min-width:300px;}
    .logo{width:144px;height:144px;border-radius:8px;object-fit:contain;box-shadow:0 2px 6px rgba(0,0,0,.1);background:#fff;padding:4px;}
    .title-block{display:flex;flex-direction:column;}
    .title{font-size:22px;font-weight:700;color:var(--primary);margin:0;}
    .org{font-size:15px;font-weight:600;color:var(--dark);margin-top:-4px;}
    .dev{font-size:12px;color:var(--gray);margin-top:-2px;font-style:italic;}
    .subtitle{font-size:14px;color:var(--gray);font-style:italic;margin-left:auto;white-space:nowrap;}

    label{font-weight:600;display:flex;align-items:center;gap:8px;font-size:14px;white-space:nowrap;}
    select,button{padding:10px 16px;border-radius:8px;border:1px solid var(--border);font-size:14px;transition:all .2s ease;}
    select{background:#fff;min-width:180px;max-width:260px;}
    select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,105,217,.15);outline:none;}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;white-space:nowrap;}
    button:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15);}
    button#scanButton{background:var(--success);} button#scanButton:hover:not(:disabled){background:#218838;}
    button#resetButton{background:var(--danger);} button#resetButton:hover:not(:disabled){background:#c0392b;}
    button#colorizeButton{background:#00c2cb;} button#colorizeButton:hover:not(:disabled){background:#00a0aa;}
    button:disabled{background:var(--gray);cursor:not-allowed;transform:none;box-shadow:none;opacity:.85;}

    main{flex:1;padding:24px;overflow-y:auto;display:grid;gap:28px;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));justify-items:center;}
    .chart-card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:28px 24px 22px;width:100%;max-width:550px;text-align:center;position:relative;overflow:hidden;}
    .chart-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),#00c2cb);border-radius:16px 16px 0 0;}
    .chart-card h3{margin:4px 0 16px;font-size:18px;color:var(--dark);font-weight:600;word-break:break-word;}
    .chart-summary{margin-top:8px;font-size:13px;color:var(--gray);white-space:pre-wrap;}
    #status,#error{grid-column:1/-1;text-align:center;font-size:15px;padding:10px 14px;border-radius:8px;}
    #status{background:rgba(40,167,69,.1);color:var(--success);border:1px solid rgba(40,167,69,.2);}
    #error{background:rgba(220,53,69,.08);color:var(--danger);border:1px solid rgba(220,53,69,.15);display:none;white-space:pre-wrap;}
    .footer-credit{grid-column:1/-1;text-align:center;font-size:14px;color:#888;margin-top:8px;font-style:italic;line-height:1.35;}
    .button-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}
    .selector-row{display:flex;gap:16px;flex-wrap:wrap;align-items:center;}
    @media (max-width:1024px){
      header{flex-direction:column;align-items:stretch;}
      .title-container{justify-content:center;}
      .subtitle{margin-left:0;text-align:center;}
      .selector-row{justify-content:center;}
      .button-row{justify-content:center;}
    }
  </style>
</head>

<body>
<header>
  <div class="title-container">
    <img src="norconsult-logo-black.png" alt="Norconsult logo" class="logo">
    <div class="title-block">
      <h1 class="title">aaMMIXtractor</h1>
      <div class="org">Norconsult Norge</div>
      <div class="dev">Developed by Edin Dzakmic, Norconsult, (AI-assisted development)</div>
    </div>
  </div>

  <span class="subtitle">aaMMIXtractor direkte i modellen</span>

  <div class="selector-row">
    <label>MMI Property Set:
      <select id="psetSelect" disabled><option value="">(velgâ€¦)</option></select>
    </label>
    <label>MMI property:
      <select id="propSelect" disabled><option value="">(velgâ€¦)</option></select>
    </label>
  </div>

  <div class="button-row">
    <button id="scanButton" disabled>ðŸ”„ Oppdater liste</button>
    <button id="loadButton" disabled>ðŸ“Š Hent aaMMIXtractor</button>
    <button id="colorizeButton" disabled>ðŸŽ¨ Fargelegg etter MMI</button>
    <button id="resetButton" disabled>ðŸ”„ Tilbakestill farger</button>
  </div>
</header>

<main>
  <div id="status">Kobler til Trimble Connectâ€¦</div>
  <div id="error"></div>
  <div id="chartsContainer"></div>
  <div class="footer-credit">
    MMI-oversikt basert pÃ¥ MMI-veilederen 2.0.<br>
    Filtrer bort: <b>IFCPROJECT</b> / <b>IFCSITE</b> / <b>IFCBUILDING</b> / <b>IFCBUILDINGSTOREY</b>.<br>
    Du velger <b>Property Set</b>; vi auto-velger en <b>MMI property</b> innenfor valgt set.
  </div>
</main>

<script>
  let API=null, availableProps={}, charts=[];
  const IGNORE_TYPES=new Set(["IFCPROJECT","IFCSITE","IFCBUILDING","IFCBUILDINGSTOREY"]);
  let mmiSelectionGlobal={selectionByKey:{}};

  if (window.ChartDataLabels) Chart.register(ChartDataLabels);

  const MMI_COLORS={
    "000":"#D73296","100":"#BE2823","125":"#D24B46","150":"#E17873","175":"#F0AAAA",
    "200":"#E69637","225":"#EBAF64","250":"#F0C88C","275":"#F5E6D7",
    "300":"#FAF050","325":"#D7CD41","350":"#B9AF3C","375":"#9B9632",
    "400":"#378246","425":"#4BAA5A","450":"#64C37D","475":"#9BD7A5",
    "500":"#1E46AF","600":"#9B00CD"
  };
  const EXTRA_COLORS={"HOLD":"#6b7280","--":"#9ca3af","EMPTY":"#cbd5e1"};

  const els={
    status:document.getElementById("status"),
    error:document.getElementById("error"),
    chartsContainer:document.getElementById("chartsContainer"),
    psetSelect:document.getElementById("psetSelect"),
    propSelect:document.getElementById("propSelect"),
    scanButton:document.getElementById("scanButton"),
    loadButton:document.getElementById("loadButton"),
    colorizeButton:document.getElementById("colorizeButton"),
    resetButton:document.getElementById("resetButton")
  };

  function norm(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
  function showError(msg){ els.error.textContent=msg||""; els.error.style.display=msg?"block":"none"; }
  function setBusy(isBusy){
    [els.scanButton,els.loadButton,els.colorizeButton,els.resetButton].forEach(btn=>{
      if(!btn) return;
      if(isBusy){ btn.dataset.prevDisabled=btn.disabled?"true":"false"; btn.disabled=true; }
      else if(btn.dataset.prevDisabled==="false") btn.disabled=false;
    });
  }

  function getIfcType(objProps){
    const direct=norm(objProps?.ifcType||objProps?.ifcEntity||objProps?.entityType||objProps?.type);
    return direct ? direct.toUpperCase() : "";
  }
  function isIgnored(objProps){
    const t=getIfcType(objProps);
    if (t && IGNORE_TYPES.has(t)) return true;
    const n=norm(objProps?.name||objProps?.objectName||objProps?.displayName).toUpperCase();
    for (const it of IGNORE_TYPES){ if(n===it || n.includes(it)) return true; }
    return false;
  }

  function clearCharts(){ charts.forEach(c=>c.destroy()); charts=[]; els.chartsContainer.innerHTML=""; }
  function resetSelectors(){
    els.psetSelect.innerHTML='<option value="">(velgâ€¦)</option>'; els.psetSelect.disabled=true;
    els.propSelect.innerHTML='<option value="">(velgâ€¦)</option>'; els.propSelect.disabled=true;
  }

  // --- Robust parsing / kategorier ---
  const DASH_CHARS=/[\u2010\u2011\u2012\u2013\u2014\u2015\u2212\uFE58\uFE63\uFF0D]/g;
  function normalizeForDashCheck(s){
    return String(s||"").trim().replace(DASH_CHARS,"-").replace(/\s+/g,"");
  }
  function parseMMIKey(rawValue){
    if(rawValue===null||rawValue===undefined) return "EMPTY";
    const s0=String(rawValue).trim();
    if(!s0) return "EMPTY";

    const up=s0.toUpperCase();
    if(up==="HOLD") return "HOLD";

    const dashNorm=normalizeForDashCheck(s0);
    if(dashNorm && /^-+$/.test(dashNorm)) return "--";

    const m=s0.match(/\b\d{3}\b/);
    if(m) return m[0];

    return "EMPTY";
  }
  function keyLabel(key){ if(key==="HOLD") return "HOLD"; if(key==="--") return "--"; if(key==="EMPTY") return "Tom / ingen MMI"; return `MMI ${key}`; }
  function keyColor(key){ return MMI_COLORS[key] || EXTRA_COLORS[key] || "#cccccc"; }

  // âœ… Auto-velg MMI-property INNEFOR valgt pset
  const MMI_PROP_PRIORITY = ["MMI", "01_MMI", "MMI_AVINOR"];
  function pickBestMMIPropertyFromList(props){
    if(!props?.length) return "";
    const lower = props.map(p => ({ p, l: p.toLowerCase() }));

    // 1) eksakte treff i prioritert rekkefÃ¸lge
    for (const cand of MMI_PROP_PRIORITY){
      const hit = lower.find(x => x.l === cand.toLowerCase());
      if(hit) return hit.p;
    }
    // 2) noe som inneholder "mmi"
    const contains = lower.find(x => x.l.includes("mmi"));
    if(contains) return contains.p;

    // 3) ingenting - la bruker velge
    return "";
  }

  function populatePropSelect(pset){
    els.propSelect.innerHTML='<option value="">(velgâ€¦)</option>';
    els.propSelect.disabled=true;

    if(!pset || !availableProps[pset]) return;

    const props = Array.from(availableProps[pset]).sort((a,b)=>a.localeCompare(b,"nb"));
    props.forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p; opt.textContent=p;
      els.propSelect.appendChild(opt);
    });

    els.propSelect.disabled=false;

    // auto-velg MMI property innenfor valgt pset (men bruker kan overstyre)
    const autoProp = pickBestMMIPropertyFromList(props);
    if(autoProp){
      els.propSelect.value = autoProp;
      els.status.textContent = `âœ… Auto-valgte MMI property: Â«${autoProp}Â» i Â«${pset}Â». (Du kan endre manuelt)`;
    } else {
      els.status.textContent = `â„¹ï¸ Fant ingen tydelig MMI-property i Â«${pset}Â». Velg property manuelt.`;
    }
  }

  async function connect(){
    try{
      API=await TrimbleConnectWorkspace.connect(window.parent, ()=>{}, 30000);
      els.status.textContent="âœ… Tilkoblet â€“ trykk Â«Oppdater listeÂ» for Ã¥ hente MMI-egenskaper.";
      els.scanButton.disabled=false;
    }catch(e){
      showError("Kunne ikke koble til Trimble Connect: " + (e?.message||e));
      els.status.textContent="âŒ Feil ved tilkobling.";
    }
  }

  async function scanProperties(){
    if(!API){ showError("API ikke klar. Vent litt og prÃ¸v igjen."); return; }

    clearCharts(); showError(""); availableProps={}; resetSelectors();
    els.loadButton.disabled=true; els.colorizeButton.disabled=true; els.resetButton.disabled=true;

    els.status.textContent="ðŸ” Skanner modell for Property Sets (filtrerer bort topp-IFC)â€¦";
    setBusy(true);

    try{
      const models=await API.viewer.getObjects();
      if(!models?.length){ els.status.textContent="â„¹ï¸ Fant ingen objekter i visningen."; return; }

      for(const m of models){
        const modelId=m.modelId||m.modelid||m["model Id"];
        const objs=m.objects||[];
        if(!modelId||!objs.length) continue;

        const rids=Array.from(new Set(objs.map(o=>Number(o.id)).filter(Number.isFinite)));
        if(!rids.length) continue;

        const propsArr=await API.viewer.getObjectProperties(modelId, rids);

        for(let i=0;i<rids.length;i++){
          const objProps=propsArr?.[i];
          if(!objProps) continue;
          if(isIgnored(objProps)) continue;

          for(const pset of (objProps.properties||[])){
            const name=pset.name||"";
            if(!name) continue;
            if(!availableProps[name]) availableProps[name]=new Set();
            for(const p of (pset.properties||[])){
              const pn=p?.name;
              if(pn) availableProps[name].add(pn);
            }
          }
        }
      }

      const psetNames=Object.keys(availableProps);
      if(!psetNames.length){ els.status.textContent="â„¹ï¸ Ingen Property Sets funnet (etter filtrering)."; return; }

      psetNames.sort((a,b)=>a.localeCompare(b,"nb")).forEach(n=>{
        const opt=document.createElement("option"); opt.value=n; opt.textContent=n;
        els.psetSelect.appendChild(opt);
      });

      els.psetSelect.disabled=false;

      // foreslÃ¥ pset som inneholder mmi i navnet, men brukeren kan endre
      const autoPset =
        psetNames.find(n=>n.toLowerCase().includes("mmi")) ||
        psetNames.find(n=>n === "0_Generell");

      if(autoPset){
        els.psetSelect.value = autoPset;
        populatePropSelect(autoPset);
      } else {
        els.status.textContent="âœ… Ferdig skannet. Velg MMI Property Set.";
      }

      els.loadButton.disabled=false;
    }catch(e){
      showError("Feil under skanning: " + (e?.message||e));
      els.status.textContent="âŒ Klarte ikke Ã¥ skanne.";
    }finally{ setBusy(false); }
  }

  // âœ… Finn MMI-verdien KUN i valgt pset + valgt property (ingen fallback pÃ¥ andre pset)
  function findValueInChosenPset(objProps, chosenPset, chosenProp){
    for(const ps of (objProps?.properties||[])){
      if(norm(ps?.name) !== norm(chosenPset)) continue;
      for(const p of (ps?.properties||[])){
        if(norm(p?.name) === norm(chosenProp)) return p?.value;
      }
    }
    return null;
  }

  async function getMMIData(chosenPset, chosenProp){
    const countsByKey={}, selectionByKey={};
    let missingPset=0, missingProp=0, ok=0;

    const models=await API.viewer.getObjects();
    if(!models?.length) return { countsByKey, selectionByKey:{}, total:0, dbg:"Ingen modeller." };

    for(const m of models){
      const modelId=m.modelId||m.modelid||m["model Id"];
      const objs=m.objects||[];
      if(!modelId||!objs.length) continue;

      const rids=Array.from(new Set(objs.map(o=>Number(o.id)).filter(Number.isFinite)));
      if(!rids.length) continue;

      const propsArr=await API.viewer.getObjectProperties(modelId, rids);

      for(let i=0;i<rids.length;i++){
        const rid=rids[i];
        const objProps=propsArr?.[i];
        if(!objProps) continue;
        if(isIgnored(objProps)) continue;

        const hasPset = (objProps.properties || []).some(ps => norm(ps?.name) === norm(chosenPset));
        if(!hasPset) missingPset++;

        const val = findValueInChosenPset(objProps, chosenPset, chosenProp);
        if(val === null && hasPset) missingProp++;
        else if(val !== null) ok++;

        const key=parseMMIKey(val);
        countsByKey[key]=(countsByKey[key]||0)+1;

        if(!selectionByKey[key]) selectionByKey[key]={};
        if(!selectionByKey[key][modelId]) selectionByKey[key][modelId]=[];
        selectionByKey[key][modelId].push(rid);
      }
    }

    const total=Object.values(countsByKey).reduce((a,b)=>a+b,0);
    const dbg =
`Valgt pset: ${chosenPset}
Valgt prop: ${chosenProp}
Objekter uten pset: ${missingPset}
Objekter med pset men uten prop/verdi: ${missingProp}
Objekter med prop/verdi: ${ok}`;
    return { countsByKey, selectionByKey, total, dbg };
  }

  async function highlightKey(key, selectionByKey){
    const perModel=selectionByKey[key]||{};
    const modelObjectIds=[];
    let total=0;
    for(const modelId in perModel){
      const ids=perModel[modelId];
      if(ids?.length){ modelObjectIds.push({modelId, objectRuntimeIds: ids}); total+=ids.length; }
    }
    if(!modelObjectIds.length){ els.status.textContent=`Ingen objekter for ${keyLabel(key)}.`; return; }
    try{
      await API.viewer.setSelection({ modelObjectIds }, "replace");
      els.status.textContent=`ðŸ”Ž Markerte ${total} objekter (${keyLabel(key)}) i modellen.`;
    }catch(e){ showError("Feil ved markering: " + (e?.message||e)); }
  }

  function hexToRgba(hex){
    const clean=hex.replace("#","");
    const bigint=parseInt(clean,16);
    return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255, a:255 };
  }

  function createPie(pset, prop, mmiData){
    const { countsByKey, selectionByKey, total, dbg } = mmiData;

    const card=document.createElement("div");
    card.className="chart-card";
    const h=document.createElement("h3");
    h.textContent=`aaMMIXtractor â€“ ${pset} / ${prop}`;
    card.appendChild(h);

    const canvas=document.createElement("canvas");
    card.appendChild(canvas);

    const keys=Object.keys(countsByKey);
    const numeric=keys.filter(k=>/^\d{3}$/.test(k)).sort((a,b)=>Number(a)-Number(b));
    const tail=["HOLD","--","EMPTY"].filter(k=>keys.includes(k));
    const ordered=[...numeric, ...tail];

    const labels=ordered.map(keyLabel);
    const data=ordered.map(k=>countsByKey[k]);
    const colors=ordered.map(keyColor);

    const summary=document.createElement("div");
    summary.className="chart-summary";
    summary.textContent =
      `Totalt ${total} objekter (topp-IFC filtrert bort).\n` +
      `--: ${countsByKey["--"]||0} | HOLD: ${countsByKey["HOLD"]||0} | Tom/ingen: ${countsByKey["EMPTY"]||0}\n\n` +
      `${dbg}`;
    card.appendChild(summary);

    els.chartsContainer.appendChild(card);

    const chart=new Chart(canvas,{
      type:"pie",
      data:{ labels, datasets:[{ data, backgroundColor: colors, borderColor:"#fff", borderWidth:4, hoverOffset:12 }] },
      options:{
        responsive:true,
        plugins:{
          legend:{ position:"bottom", labels:{ font:{ size:14 }, padding:20, usePointStyle:true } },
          tooltip:{ callbacks:{ label: ctx => {
            const v=ctx.parsed; const pct=total ? (v/total*100).toFixed(1) : 0;
            return `${ctx.label}: ${pct}% (${v} objekter)`;
          }}},
          datalabels:{
            formatter: value => { const pct=total ? (value/total*100).toFixed(1) : 0; return `${pct} %`; },
            color:"#fff", font:{ weight:"bold", size:13 }, anchor:"center", align:"center", clamp:true
          }
        },
        onClick:(event,elements)=>{
          if(!elements?.length) return;
          const idx=elements[0].index;
          const key=ordered[idx];
          highlightKey(key, selectionByKey);
        }
      }
    });

    charts.push(chart);
    mmiSelectionGlobal={ selectionByKey };
  }

  async function loadMMIChart(){
    clearCharts(); showError("");

    const pset=els.psetSelect.value;
    const prop=els.propSelect.value;

    if(!pset){ showError("Velg MMI Property Set fÃ¸rst."); return; }
    if(!prop){ showError("Velg MMI property (auto-velg forsÃ¸kes, ellers velg manuelt)."); return; }

    els.status.textContent="ðŸ“ˆ Leser MMI-verdier i valgt Property Setâ€¦";
    els.colorizeButton.disabled=true; els.resetButton.disabled=true;
    setBusy(true);

    try{
      const mmiData=await getMMIData(pset, prop);
      if(!mmiData.total){ els.status.textContent="Ingen objekter funnet (etter filtrering)."; return; }
      createPie(pset, prop, mmiData);
      els.status.textContent="âœ… Klar! Tom/ingen MMI gjelder nÃ¥ kun valgt pset + valgt property.";
      els.colorizeButton.disabled=false; els.resetButton.disabled=false;
    }catch(e){
      showError("Feil ved henting av MMI-data: " + (e?.message||e));
      els.status.textContent="âŒ Klarte ikke Ã¥ generere MMI-kakediagram.";
    }finally{ setBusy(false); }
  }

  async function colorizeAllMMI(){
    const selectionByKey=mmiSelectionGlobal.selectionByKey||{};
    const keys=Object.keys(selectionByKey);
    if(!keys.length){ showError("Ingen MMI-data Ã¥ fargelegge. Hent aaMMIXtractor fÃ¸rst."); return; }

    showError(""); els.status.textContent="ðŸŽ¨ Fargelegger objekter etter MMI-kategoriâ€¦";
    setBusy(true);

    try{
      await API.viewer.setObjectState(undefined, { color:"reset" });

      for(const key of keys){
        const perModel=selectionByKey[key];
        const modelObjectIds=[];
        for(const modelId in perModel){
          const ids=perModel[modelId];
          if(ids?.length) modelObjectIds.push({ modelId, objectRuntimeIds: ids });
        }
        if(!modelObjectIds.length) continue;
        await API.viewer.setObjectState({ modelObjectIds }, { color: hexToRgba(keyColor(key)) });
      }

      els.status.textContent="ðŸŽ¨ Fargelegging fullfÃ¸rt.";
      els.resetButton.disabled=false;
    }catch(e){
      showError("Feil ved fargelegging: " + (e?.message||e));
      els.status.textContent="âŒ Klarte ikke Ã¥ fargelegge objekter.";
    }finally{ setBusy(false); }
  }

  async function resetAll(){
    setBusy(true); showError(""); clearCharts();
    try{
      await API.viewer.setObjectState(undefined, { color:"reset" });
      els.status.textContent="ðŸ”„ Modellen er tilbakestilt til originalfarger.";
    }catch(e){
      showError("Feil ved tilbakestilling: " + (e?.message||e));
      els.status.textContent="âŒ Klarte ikke Ã¥ tilbakestille.";
    }finally{
      els.colorizeButton.disabled=true; els.resetButton.disabled=true; els.loadButton.disabled=false;
      setBusy(false);
    }
  }

  // wiring
  els.scanButton.onclick=scanProperties;
  els.loadButton.onclick=loadMMIChart;
  els.colorizeButton.onclick=colorizeAllMMI;
  els.resetButton.onclick=resetAll;

  els.psetSelect.onchange = e => {
    clearCharts(); showError("");
    populatePropSelect(e.target.value);
    els.colorizeButton.disabled=true;
    els.resetButton.disabled=true;
  };

  // hvis du bytter property manuelt, nullstiller vi charts
  els.propSelect.onchange = () => {
    clearCharts(); showError("");
    els.colorizeButton.disabled=true;
    els.resetButton.disabled=true;
  };

  connect();
</script>
</body>
</html>

